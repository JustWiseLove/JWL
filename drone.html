<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Command Center - Just Wise Love</title>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Ensure full width on desktop */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        header, main {
            width: 100%;
            box-sizing: border-box;
        }

        .intro, .item, .featured-article {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .item-content {
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: linear-gradient(90deg, #f0f0f0, #d3d3d3);
        }

        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ccc;
            color: #333;
        }

        th {
            background: linear-gradient(90deg, #2a6626, #6b9e31);
            color: #fff;
            font-family: 'Audiowide', Arial, sans-serif;
        }

        tr:nth-child(even) {
            background: #e8e8e8;
        }

        .good {
            color: green;
            font-weight: bold;
        }

        .caution {
            color: orange;
            font-weight: bold;
        }

        .danger {
            color: red;
            font-weight: bold;
        }

        #safety-content {
            display: none;
        }

        #safety-content.active {
            display: block;
        }

        /* Windy widget */
        .windy-widget {
            margin: 20px 0;
            height: 800px; /* Doubled from 400px for desktop */
            width: 100%;
        }

        .windy-widget iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Warning for NWS fallback */
        .nws-fallback {
            color: orange;
            font-style: italic;
        }

        /* Ensure featured article text is visible */
        .featured-article .article-preview {
            color: #fff;
        }

        .featured-article .article-preview a {
            color: #d4af37;
            text-decoration: none;
        }

        /* Adjust scroll position to include titles */
        [id="wind-map"],
        [id="advisory"],
        [id="current"],
        [id="hourly"],
        [id="weekly"],
        [id="safety"] {
            scroll-margin-top: 80px; /* Adjust based on header height; tweak if needed */
        }

        /* Responsive design for mobile */
        @media (max-width: 767px) {
            .intro, .item, .featured-article, footer {
                padding: 10px;
            }

            .windy-widget {
                height: 300px;
            }

            [id="wind-map"],
            [id="advisory"],
            [id="current"],
            [id="hourly"],
            [id="weekly"],
            [id="safety"] {
                scroll-margin-top: 60px; /* Adjust for mobile header height */
            }
        }
    </style>
</head>
<body>
    <header>
        <button class="hamburger-left">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="logo">
            <a href="/"><h1>DRONE</h1></a>
        </div>
        <button class="hamburger-right">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <ul class="nav-menu-left">
            <li><a href="#wind-map">Wind Map</a></li>
            <li><a href="#advisory">Advisory</a></li>
            <li><a href="#current">Current</a></li>
        </ul>
        <ul class="nav-menu-right">
            <li><a href="#hourly">Hourly</a></li>
            <li><a href="#weekly">Weekly</a></li>
            <li><a href="#" onclick="toggleSafetySection(); return false;">Safety</a></li>
        </ul>
    </header>
    <main>
        <section class="intro">
            <div class="intro-content">
                <h2>Welcome to Your Drone Command Center</h2>
                <p>Fly your drone with confidence in Port Deposit, MD, using our real-time weather reports. Stay informed about wind speeds, gusts, and severe weather alerts to ensure safe and successful flights.</p>
            </div>
        </section>
        <!-- Interactive Wind Map -->
        <div class="item" id="wind-map">
            <div class="item-content">
                <h2>Interactive Wind Map</h2>
                <p>View real-time wind speed, gusts, and direction for Port Deposit, MD (21904), and Maryland using Windy.com's interactive map. Click the map to see detailed wind data at any point.</p>
                <div class="windy-widget">
                    <iframe src="https://embed.windy.com/?lat=39.6048&lon=-76.1152&zoom=8&metricWind=mph&layer=wind" title="Windy.com Weather Map for Port Deposit, MD"></iframe>
                </div>
                <p><a href="https://www.windy.com/" target="_blank" style="color: #d4af37; text-decoration: none;">Powered by Windy.com</a></p>
            </div>
        </div>
        <div class="item" id="advisory">
            <div class="item-content">
                <h2>Weather Advisory</h2>
                <p><strong>NWS Alert:</strong> <span id="advisory-text">Loading...</span></p>
                <p><strong>Drone Flying Impact:</strong> <span id="advisory-impact">Loading...</span></p>
            </div>
        </div>
        <div class="item" id="current">
            <div class="item-content">
                <h2>Current Conditions</h2>
                <p><strong>Wind Speed:</strong> <span id="wind-speed">Loading...</span> mph</p>
                <p><strong>Wind Gusts:</strong> <span id="wind-gusts">Loading...</span> mph</p>
                <p><strong>Wind Direction:</strong> <span id="wind-direction">Loading...</span></p>
                <p><strong>Drone Flight Recommendation:</strong> <span id="flight-recommendation">Loading...</span></p>
            </div>
        </div>
        <div class="item" id="hourly">
            <div class="item-content">
                <h2>Hourly Forecast</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Wind Speed (mph)</th>
                            <th>Wind Gusts (mph)</th>
                            <th>Flight Status</th>
                        </tr>
                    </thead>
                    <tbody id="hourly-body"></tbody>
                </table>
            </div>
        </div>
        <div class="item" id="weekly">
            <div class="item-content">
                <h2>Weekly Forecast</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Wind Speed (mph)</th>
                            <th>Flight Status</th>
                        </tr>
                    </thead>
                    <tbody id="daily-body"></tbody>
                </table>
            </div>
        </div>
        <section class="featured-article" id="safety">
            <div class="article-preview">
                <i class="fas fa-cloud-showers-heavy"></i>
                <h2>FAA Drone Safety Guidelines</h2>
                <p class="preview-text">Ensure safe drone operations with these key tips: Always check wind conditions with a local anemometer, avoid flying during thunderstorms or heavy rain, and use our weekly forecast to plan flights on calm days.</p>
                <button class="read-more" onclick="toggleSafetySection()">Read More</button>
            </div>
        </section>
        <div class="item" id="safety-content">
            <div class="item-content">
                <h3>Airspace Regulations</h3>
                <p>Operate in Class G (uncontrolled) airspace unless you obtain FAA authorization for Class B, C, D, or E airspace. Use apps like B4UFLY to check airspace restrictions and avoid airports, heliports, or restricted areas like stadiums and military zones.</p>
                <h3>Operational Limits</h3>
                <p>Keep your drone below 400 feet above ground level, maintain visual line-of-sight at all times, and avoid flying over people, moving vehicles, or at night without a waiver. Maximum speed is 100 mph, and drones must weigh less than 55 lbs (including payload).</p>
                <h3>Preflight Inspections</h3>
                <p>Before every flight, check your droneâ€™s battery, propellers, motors, and sensors for damage. Verify weather conditions (e.g., wind, visibility) and ensure no Temporary Flight Restrictions (TFRs) are in effect. Register drones over 250 grams with the FAA.</p>
                <h3>Emergency Procedures</h3>
                <p>In case of lost link or low battery, set your drone to Return-to-Home (RTH) mode if available, or land safely in a clear area. Avoid flying near emergency response activities (e.g., wildfires, accidents). Report any incidents causing injury or over $500 in damage to the FAA within 10 days.</p>
                <h3>Pilot Responsibilities</h3>
                <p>Maintain your Part 107 Remote Pilot Certificate by passing recurrent training every 24 months. Never operate recklessly or under the influence of drugs/alcohol. Yield right-of-way to manned aircraft and prioritize safety in all operations.</p>
            </div>
        </div>
    </main>
    <footer>
            <br><p>Data provided by <a href="https://www.weather.gov/">National Weather Service</a> and <a href="https://www.windy.com/">Windy.com</a>. 
                Wind data is sourced from METAR observations (KILG, Wilmington, DE). <span id="data-source" class="nws-fallback"></span>
                Click the Windy.com map for real-time wind and gust visuals. Always verify conditions with a local anemometer before flying.</p>
    </footer>
    <script>
        // Coordinates for Port Deposit, MD
        const LAT = 39.6048;
        const LNG = -76.1152;

        // Hamburger menu toggle
        document.querySelector('.hamburger-left').addEventListener('click', () => {
            document.querySelector('.nav-menu-left').classList.toggle('active');
            document.querySelector('.hamburger-left').classList.toggle('active');
        });

        document.querySelector('.hamburger-right').addEventListener('click', () => {
            document.querySelector('.nav-menu-right').classList.toggle('active');
            document.querySelector('.hamburger-right').classList.toggle('active');
        });

        // Toggle safety content and scroll to section
        function toggleSafetySection() {
            const safetyContent = document.getElementById('safety-content');
            safetyContent.classList.toggle('active'); // Toggle the detailed content

            // Scroll to the #safety section
            const safetySection = document.getElementById('safety');
            safetySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Function to convert wind direction to cardinal direction
        function degreesToDirection(direction) {
            if (typeof direction === 'string') {
                return direction; // NWS or METAR 'Variable'
            }
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(direction / 22.5) % 16;
            return directions[index];
        }

        // Function to determine drone flight recommendation
        function getFlightRecommendation(windSpeed, windGusts = null, hasSevereWeather = false) {
            if (hasSevereWeather) {
                return { text: 'Not Safe to Fly (Severe Weather)', class: 'danger' };
            }
            if (windGusts !== null && windGusts !== 'N/A') {
                if (windSpeed <= 15 && windGusts <= 20) {
                    return { text: 'Good to Fly', class: 'good' };
                } else if (windSpeed <= 24 && windGusts <= 30) {
                    return { text: 'Fly with Caution', class: 'caution' };
                } else {
                    return { text: 'Not Safe to Fly', class: 'danger' };
                }
            } else {
                if (windSpeed <= 15) {
                    return { text: 'Good to Fly', class: 'good' };
                } else if (windSpeed <= 24) {
                    return { text: 'Fly with Caution', class: 'caution' };
                } else {
                    return { text: 'Not Safe to Fly', class: 'danger' };
                }
            }
        }

        // Function to check if advisory applies to Port Deposit
        function checkAdvisoryRelevance(forecastData) {
            const severeTerms = ['thunderstorm', 'heavy rain', 'tornado', 'flooding'];
            let isRelevant = false;
            let advisoryImpact = 'The advisory for heavy rain and severe weather in the Deep South and Lower Mississippi Valley is unlikely to affect Port Deposit, MD. However, always check local conditions before flying.';

            for (let i = 0; i < Math.min(12, forecastData.properties.periods.length); i++) {
                const period = forecastData.properties.periods[i];
                const shortForecast = period.shortForecast.toLowerCase();
                if (severeTerms.some(term => shortForecast.includes(term))) {
                    isRelevant = true;
                    advisoryImpact = 'Severe weather (e.g., thunderstorms or heavy rain) is forecast, making drone flying unsafe. Avoid flying until conditions improve.';
                    break;
                }
            }

            return { isRelevant, advisoryImpact };
        }

        // Function to fetch and parse METAR data (KILG primary, KPHL backup)
        async function fetchMETAR(retries = 2, delay = 1000) {
            // Check cached METAR data
            const cachedData = localStorage.getItem('metarData');
            let cachedMetar = null;
            if (cachedData) {
                try {
                    cachedMetar = JSON.parse(cachedData);
                    if (Date.now() - cachedMetar.timestamp < 3600000) {
                        console.log('Using cached METAR data');
                        return cachedMetar.data;
                    }
                } catch (e) {
                    console.warn('Invalid cached METAR data, fetching new');
                }
            }

            // Try KILG, then KPHL
            const stations = [
                { id: 'KILG', url: 'https://tgftp.nws.noaa.gov/data/observations/metar/stations/KILG.TXT' },
                { id: 'KPHL', url: 'https://tgftp.nws.noaa.gov/data/observations/metar/stations/KPHL.TXT' }
            ];

            for (const station of stations) {
                for (let attempt = 0; attempt <= retries; attempt++) {
                    try {
                        const response = await fetch(station.url, {
                            headers: { 'User-Agent': 'DroneWeatherApp (your-email@example.com)' }
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: Failed to fetch METAR data for ${station.id}`);
                        }
                        const text = await response.text();
                        const lines = text.split('\n').filter(line => line.trim());
                        if (lines.length < 2) {
                            throw new Error(`Empty or invalid METAR response for ${station.id}`);
                        }
                        const metar = lines[lines.length - 1].trim();

                        // Parse METAR for wind speed, gusts, and direction
                        const windMatch = metar.match(/(VRB|\d{3})(\d{2})(G(\d{2}))?KT/);
                        if (!windMatch) {
                            console.warn(`No valid wind data in METAR for ${station.id}: ${metar}`);
                            throw new Error(`No valid wind data for ${station.id}`);
                        }

                        const windDirectionRaw = windMatch[1];
                        const windDirection = windDirectionRaw === 'VRB' ? 'Variable' : parseInt(windDirectionRaw);
                        const windSpeedKnots = parseInt(windMatch[2]);
                        const windGustsKnots = windMatch[4] ? parseInt(windMatch[4]) : null;

                        // Convert knots to mph
                        const windSpeed = Math.round(windSpeedKnots * 1.15078);
                        const windGusts = windGustsKnots ? Math.round(windGustsKnots * 1.15078) : Math.round(windSpeed * 1.8); // Changed from 1.5 to 1.8

                        const metarData = {
                            windSpeed,
                            windGusts,
                            windDirection: windDirection === 'Variable' ? windDirection : degreesToDirection(windDirection)
                        };

                        // Cache the successful fetch
                        localStorage.setItem('metarData', JSON.stringify({
                            data: metarData,
                            timestamp: Date.now()
                        }));

                        console.log(`Successfully fetched METAR from ${station.id}`);
                        return metarData;
                    } catch (error) {
                        console.error(`METAR fetch attempt ${attempt + 1} for ${station.id} failed:`, error.message);
                        if (attempt < retries) {
                            console.log(`Retrying ${station.id} in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
            }

            // All fetches failed, use cached data if available
            if (cachedMetar) {
                console.log('All METAR fetches failed, using cached METAR data');
                return cachedMetar.data;
            }

            console.error('All METAR fetches failed, no valid cached data');
            return null;
        }

        // Fetch weather data from METAR and NWS API
        async function fetchWeather() {
            try {
                // Fetch METAR data for current conditions
                const metarData = await fetchMETAR();

                // Step 1: Get gridpoint for Port Deposit, MD
                const pointResponse = await fetch(`https://api.weather.gov/points/${LAT},${LNG}`, {
                    headers: { 'User-Agent': 'DroneWeatherApp (your-email@example.com)' }
                });
                if (!pointResponse.ok) throw new Error('Failed to fetch gridpoint');
                const pointData = await pointResponse.json();
                const hourlyForecastUrl = pointData.properties.forecastHourly;
                const dailyForecastUrl = pointData.properties.forecast;

                // Step 2: Fetch hourly forecast (for advisory check and 12-hour forecast)
                const hourlyResponse = await fetch(hourlyForecastUrl, {
                    headers: { 'User-Agent': 'DroneWeatherApp (your-email@example.com)' }
                });
                if (!hourlyResponse.ok) throw new Error('Failed to fetch hourly forecast');
                const hourlyData = await hourlyResponse.json();

                // Step 3: Fetch daily forecast (for weekly forecast)
                const dailyResponse = await fetch(dailyForecastUrl, {
                    headers: { 'User-Agent': 'DroneWeatherApp (your-email@example.com)' }
                });
                if (!dailyResponse.ok) throw new Error('Failed to fetch daily forecast');
                const dailyData = await dailyResponse.json();

                // Process advisory
                const advisory = checkAdvisoryRelevance(hourlyData);
                document.getElementById('advisory-text').textContent = 'Heavy rain and severe weather forecast for the Deep South and Lower Mississippi Valley, with potential for flash flooding, large hail, and tornadoes.';
                const advisoryImpactElement = document.getElementById('advisory-impact');
                advisoryImpactElement.textContent = advisory.advisoryImpact;
                if (advisory.isRelevant) {
                    advisoryImpactElement.className = 'danger';
                }

                // Process current conditions (prefer METAR, fallback to NWS)
                let windSpeed, windGusts, windDirection, hasSevereWeather = advisory.isRelevant;
                let usingNWS = false;
                if (metarData) {
                    windSpeed = metarData.windSpeed;
                    windGusts = metarData.windGusts;
                    windDirection = metarData.windDirection;
                } else {
                    usingNWS = true;
                    const current = hourlyData.properties.periods[0];
                    windSpeed = parseInt(current.windSpeed) || 0;
                    windDirection = current.windDirection || 'Unknown';
                    const forecastText = (current.shortForecast || '') + ' ' + (current.detailedForecast || '');
                    const gustMatch = forecastText.match(/gust(s|ing)? (to|as high as) (\d+) mph/i);
                    windGusts = gustMatch ? parseInt(gustMatch[3]) : Math.round(windSpeed * 1.8); // Changed from 1.5 to 1.8
                }

                // Update current weather
                document.getElementById('wind-speed').textContent = windSpeed;
                document.getElementById('wind-gusts').textContent = windGusts;
                document.getElementById('wind-direction').textContent = windDirection;
                const recommendation = getFlightRecommendation(windSpeed, windGusts, hasSevereWeather);
                const recommendationElement = document.getElementById('flight-recommendation');
                recommendationElement.textContent = recommendation.text;
                recommendationElement.className = recommendation.class;

                // Update data source note in footer
                document.getElementById('data-source').textContent = usingNWS ? 'Warning: Using NWS data due to METAR unavailability. ' : '';

                // Process 12-hour hourly forecast
                const hourlyBody = document.getElementById('hourly-body');
                hourlyBody.innerHTML = '';
                const now = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });
                const currentHour = new Date(now).getHours();
                const currentDate = new Date(now);

                let periods = hourlyData.properties.periods;
                let selectedPeriods = [];
                let periodsAdded = 0;

                for (let period of periods) {
                    const periodTime = new Date(period.startTime);
                    const periodHour = periodTime.getHours();
                    const periodDate = periodTime.getDate();

                    if ((periodDate === currentDate.getDate() && periodHour >= currentHour) || periodDate > currentDate.getDate()) {
                        if (periodsAdded < 12) {
                            selectedPeriods.push(period);
                            periodsAdded++;
                        }
                    }
                }

                for (let period of selectedPeriods) {
                    const time = new Date(period.startTime).toLocaleTimeString([], { hour: 'numeric', hour12: true });
                    const periodWindSpeed = parseInt(period.windSpeed) || 0;
                    let periodWindGusts = null;
                    const forecastText = (period.shortForecast || '') + ' ' + (period.detailedForecast || '');
                    const gustMatch = forecastText.match(/gust(s|ing)? (to|as high as) (\d+) mph/i);
                    if (gustMatch) {
                        periodWindGusts = parseInt(gustMatch[3]);
                    } else {
                        periodWindGusts = Math.round(periodWindSpeed * 1.8); // Changed from 1.5 to 1.8
                    }
                    const periodHasSevereWeather = period.shortForecast.toLowerCase().includes('thunderstorm') || period.shortForecast.toLowerCase().includes('heavy rain');
                    const periodRecommendation = getFlightRecommendation(periodWindSpeed, periodWindGusts, periodHasSevereWeather);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${time}</td>
                        <td>${periodWindSpeed}</td>
                        <td>${periodWindGusts}</td>
                        <td class="${periodRecommendation.class}">${periodRecommendation.text}</td>
                    `;
                    hourlyBody.appendChild(row);
                }

                // Process weekly forecast
                const dailyBody = document.getElementById('daily-body');
                dailyBody.innerHTML = '';
                const dailyPeriods = dailyData.properties.periods.slice(0, 20);
                for (let i = 0; i < dailyPeriods.length; i += 2) {
                    const period = dailyPeriods[i];
                    const date = new Date(period.startTime).toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
                    const periodWindSpeed = parseInt(period.windSpeed) || 0;
                    const periodHasSevereWeather = period.shortForecast.toLowerCase().includes('thunderstorm') || period.shortForecast.toLowerCase().includes('heavy rain');
                    const periodRecommendation = getFlightRecommendation(periodWindSpeed, null, periodHasSevereWeather);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${periodWindSpeed}</td>
                        <td class="${periodRecommendation.class}">${periodRecommendation.text}</td>
                    `;
                    dailyBody.appendChild(row);
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
                document.getElementById('advisory-text').textContent = 'Error loading advisory';
                document.getElementById('advisory-impact').textContent = 'Unable to assess impact';
                document.getElementById('wind-speed').textContent = 'Error';
                document.getElementById('wind-gusts').textContent = 'Error';
                document.getElementById('wind-direction').textContent = 'Error';
                document.getElementById('flight-recommendation').textContent = 'Unable to load data';
                document.getElementById('data-source').textContent = 'Error: Unable to load weather data';
            }
        }

        // Fetch weather data on page load
        fetchWeather();

        // Refresh every 5 minutes
        setInterval(() => {
            fetchWeather();
        }, 300000);
    </script>
</body>
</html>
